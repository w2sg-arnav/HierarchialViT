2025-05-28 13:04:21 - root - INFO - [setup_logging:75] - Logging configured. Log file: /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/finetune_hvt_full_20250528_130421.log. Logger 'root' Effective Level: DEBUG
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:186] - ======== Starting Phase 4: HVT Fine-tuning (Run ID: 20250528_130421) ========
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:187] - Full run configuration: {'seed': 42, 'device': 'cuda', 'log_dir': 'logs_finetune_full_v1', 'log_file_finetune': 'finetune_hvt_full.log', 'best_model_filename': 'best_finetuned_hvt_full.pth', 'final_model_filename': 'final_finetuned_hvt_full.pth', 'checkpoint_save_dir_name': 'checkpoints_full_v1', 'data_root': '/teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection', 'original_dataset_name': 'Original Dataset', 'augmented_dataset_name': None, 'img_size': (448, 448), 'num_classes': 7, 'train_split_ratio': 0.8, 'normalize_data': True, 'use_weighted_sampler': True, 'num_workers': 4, 'prefetch_factor': 2, 'model_architecture_name': 'DiseaseAwareHVT_FullFinetune', 'pretrained_checkpoint_path': '/teamspace/studios/this_studio/cvpr25/phase3_pretraining/pretrain_checkpoints_hvt_xl/hvt_xl_simclr_best_probe.pth', 'load_pretrained_backbone': True, 'freeze_backbone_epochs': 0, 'unfreeze_backbone_lr_factor': 0.1, 'hvt_params_for_model_init': {'patch_size': 14, 'embed_dim_rgb': 192, 'embed_dim_spectral': 192, 'spectral_channels': 0, 'depths': [3, 6, 24, 3], 'num_heads': [6, 12, 24, 48], 'mlp_ratio': 4.0, 'qkv_bias': True, 'model_drop_rate': 0.1, 'attn_drop_rate': 0.0, 'drop_path_rate': 0.1, 'norm_layer_name': 'LayerNorm', 'use_dfca': False, 'use_gradient_checkpointing': False, 'ssl_enable_mae': False, 'ssl_enable_contrastive': False, 'enable_consistency_loss_heads': False}, 'enable_torch_compile': False, 'torch_compile_mode': 'reduce-overhead', 'matmul_precision': 'high', 'cudnn_benchmark': True, 'epochs': 200, 'batch_size': 16, 'accumulation_steps': 2, 'amp_enabled': True, 'clip_grad_norm': 1.0, 'log_interval': 10, 'optimizer': 'AdamW', 'learning_rate': 2e-05, 'head_lr_multiplier': 5.0, 'weight_decay': 0.05, 'optimizer_params': {'betas': (0.9, 0.999)}, 'scheduler': 'WarmupCosine', 'warmup_epochs': 5, 'eta_min_lr': 1e-07, 'loss_label_smoothing': 0.1, 'augmentations_enabled': True, 'evaluate_every_n_epochs': 1, 'early_stopping_patience': 15, 'metric_to_monitor_early_stopping': 'f1_macro', 'ssl_pretrain_img_size_fallback': (448, 448)}
2025-05-28 13:04:21 - __main__ - INFO - [set_global_seed:81] - Global random seed set to: 42
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:191] - Using device: cuda
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:192] - GPU: Tesla T4; CUDA Ver: 12.1
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:54] - [DATASET INIT - train] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (448, 448)
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:67] - [DATASET INIT - train] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:98] - [DATASET INIT - train] Total valid image paths collected: 2137 from ~2137 items considered.
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:111] - [DATASET INIT - train] Dataset split size: 1709 samples.
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:123] - [DATASET INIT - train] Base RGB Transforms: Compose(
      ToImage()
      ToDtype(scale=False)
      Resize(size=[448, 448], interpolation=InterpolationMode.BICUBIC, antialias=True)
      Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225], inplace=False)
)
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:54] - [DATASET INIT - val] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (448, 448)
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:67] - [DATASET INIT - val] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:98] - [DATASET INIT - val] Total valid image paths collected: 2137 from ~2137 items considered.
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:111] - [DATASET INIT - val] Dataset split size: 428 samples.
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [__init__:123] - [DATASET INIT - val] Base RGB Transforms: Compose(
      ToImage()
      ToDtype(scale=False)
      Resize(size=[448, 448], interpolation=InterpolationMode.BICUBIC, antialias=True)
      Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225], inplace=False)
)
2025-05-28 13:04:21 - phase4_finetuning.dataset - INFO - [get_class_weights:180] - Computed class weights for split 'train': [1.191 0.684 1.179 1.115 1.387 0.533 2.806]
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:207] - Using WeightedRandomSampler.
2025-05-28 13:04:21 - __main__ - INFO - [main_execution_logic:212] - Dataloaders created. Train batches: 106, Val batches: 27
2025-05-28 13:04:21 - phase2_model.models.hvt - INFO - [create_disease_aware_hvt:602] - Factory: Creating DiseaseAwareHVT for img_size: (448, 448), num_classes: 7
2025-05-28 13:04:24 - phase2_model.models.hvt - INFO - [__init__:325] - HVT: Running RGB stream only. No fusion.
2025-05-28 13:04:26 - phase2_model.models.hvt - INFO - [__init__:359] - DiseaseAwareHVT initialized for image size (448, 448) and 7 classes.
2025-05-28 13:04:26 - __main__.load_and_prepare_hvt_model - WARNING - [load_and_prepare_hvt_model:164] - SSL ckpt path '/teamspace/studios/this_studio/cvpr25/phase3_pretraining/pretrain_checkpoints_hvt_xl/hvt_xl_simclr_best_probe.pth' not found. Backbone random.
2025-05-28 13:04:27 - __main__ - INFO - [main_execution_logic:217] - Model ready. Total params: 273,615,751, Trainable params: 273,615,751
2025-05-28 13:04:27 - phase4_finetuning.utils.augmentations - INFO - [__init__:24] - FinetuneAugmentation initialized.
2025-05-28 13:04:27 - __main__ - INFO - [main_execution_logic:279] - Optimizer: AdamW. Initial Group LRs: [0.0001, 2.0000000000000003e-06], Group WDs: [0.05, 0.05]
2025-05-28 13:04:27 - __main__ - INFO - [main_execution_logic:293] - Scheduler: WarmupCosine (per-step). WU Steps: 265, Total Steps: 10600
2025-05-28 13:04:27 - phase4_finetuning.finetune.trainer - INFO - [__init__:44] - Finetuner initialized: device=cuda, accum_steps=2, lr_sched_on_batch=True, AMP=True
2025-05-28 13:04:27 - phase4_finetuning.finetune.trainer - INFO - [__init__:46] - Using augmentations: FinetuneAugmentation
2025-05-28 13:04:27 - __main__ - INFO - [main_execution_logic:317] - Starting fine-tuning: 200 epochs. Monitor: 'f1_macro', Patience: 15.
2025-05-28 13:05:08 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 1 training finished. Avg Loss: 2.1031, Final LR for epoch: 2.00e-05, Opt Steps: 53
2025-05-28 13:05:13 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 1.9480, accuracy: 0.2150, f1_macro: 0.0809, f1_weighted: 0.1206, precision_macro: 0.0552, precision_weighted: 0.0857, recall_macro: 0.1730, recall_weighted: 0.2150, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0000, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.3866, f1_Leaf_Variegation: 0.1799
2025-05-28 13:05:16 - phase4_finetuning.finetune.trainer - INFO - [save_model_checkpoint:173] - Model checkpoint saved to /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1/best_finetuned_hvt_full.pth
2025-05-28 13:05:16 - __main__ - INFO - [main_execution_logic:361] - E1: New best! Val f1_macro: 0.0809
2025-05-28 13:05:16 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E1 End: Alloc 3170.6MB
2025-05-28 13:05:56 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 2 training finished. Avg Loss: 2.0156, Final LR for epoch: 4.00e-05, Opt Steps: 53
2025-05-28 13:06:01 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 1.9908, accuracy: 0.0724, f1_macro: 0.0352, f1_weighted: 0.0335, precision_macro: 0.1646, precision_weighted: 0.3006, recall_macro: 0.1070, recall_weighted: 0.0724, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.1261, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.0165, f1_Leaf_Variegation: 0.1039
2025-05-28 13:06:01 - __main__ - INFO - [main_execution_logic:363] - E2: Val f1_macro (0.0352) not better than 0.0809. Patience: 1/15
2025-05-28 13:06:01 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E2 End: Alloc 3170.6MB
2025-05-28 13:06:40 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 3 training finished. Avg Loss: 2.0049, Final LR for epoch: 6.00e-05, Opt Steps: 53
2025-05-28 13:06:45 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 1.9380, accuracy: 0.2126, f1_macro: 0.1243, f1_weighted: 0.2044, precision_macro: 0.1726, precision_weighted: 0.3041, recall_macro: 0.2189, recall_weighted: 0.2126, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0645, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.6519, f1_Leaf_Variegation: 0.1538
2025-05-28 13:06:45 - phase4_finetuning.finetune.trainer - ERROR - [save_model_checkpoint:175] - Error saving model checkpoint to /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1/best_finetuned_hvt_full.pth: Parent directory /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1 does not exist.
Traceback (most recent call last):
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/finetune/trainer.py", line 172, in save_model_checkpoint
    torch.save(self.model.state_dict(), path)
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 628, in save
    with _open_zipfile_writer(f) as opened_zipfile:
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 502, in _open_zipfile_writer
    return container(name_or_buffer)
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 473, in __init__
    super().__init__(torch._C.PyTorchFileWriter(self.name))
RuntimeError: Parent directory /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1 does not exist.
2025-05-28 13:06:45 - __main__ - INFO - [main_execution_logic:361] - E3: New best! Val f1_macro: 0.1243
2025-05-28 13:06:45 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E3 End: Alloc 3170.6MB
2025-05-28 13:07:24 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 4 training finished. Avg Loss: 1.9954, Final LR for epoch: 8.00e-05, Opt Steps: 53
2025-05-28 13:07:29 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 2.0121, accuracy: 0.0678, f1_macro: 0.0182, f1_weighted: 0.0086, precision_macro: 0.0097, precision_weighted: 0.0046, recall_macro: 0.1429, recall_weighted: 0.0678, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0000, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.0000, f1_Leaf_Variegation: 0.1275
2025-05-28 13:07:29 - __main__ - INFO - [main_execution_logic:363] - E4: Val f1_macro (0.0182) not better than 0.1243. Patience: 1/15
2025-05-28 13:07:29 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E4 End: Alloc 3170.6MB
2025-05-28 13:08:09 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 5 training finished. Avg Loss: 2.0125, Final LR for epoch: 1.00e-04, Opt Steps: 53
2025-05-28 13:08:13 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 1.9852, accuracy: 0.2407, f1_macro: 0.1396, f1_weighted: 0.2246, precision_macro: 0.1533, precision_weighted: 0.2666, recall_macro: 0.2246, recall_weighted: 0.2407, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0000, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.1000, f1_Leaf_Redding: 0.7228, f1_Leaf_Variegation: 0.1543
2025-05-28 13:08:13 - phase4_finetuning.finetune.trainer - ERROR - [save_model_checkpoint:175] - Error saving model checkpoint to /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1/best_finetuned_hvt_full.pth: Parent directory /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1 does not exist.
Traceback (most recent call last):
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/finetune/trainer.py", line 172, in save_model_checkpoint
    torch.save(self.model.state_dict(), path)
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 628, in save
    with _open_zipfile_writer(f) as opened_zipfile:
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 502, in _open_zipfile_writer
    return container(name_or_buffer)
  File "/home/zeus/miniconda3/envs/cloudspace/lib/python3.10/site-packages/torch/serialization.py", line 473, in __init__
    super().__init__(torch._C.PyTorchFileWriter(self.name))
RuntimeError: Parent directory /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_full_v1/checkpoints_full_v1 does not exist.
2025-05-28 13:08:13 - __main__ - INFO - [main_execution_logic:361] - E5: New best! Val f1_macro: 0.1396
2025-05-28 13:08:13 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E5 End: Alloc 3170.6MB
2025-05-28 13:08:53 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 6 training finished. Avg Loss: 2.0081, Final LR for epoch: 1.00e-04, Opt Steps: 53
2025-05-28 13:08:58 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 2.0331, accuracy: 0.0678, f1_macro: 0.0181, f1_weighted: 0.0086, precision_macro: 0.0097, precision_weighted: 0.0046, recall_macro: 0.1429, recall_weighted: 0.0678, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0000, f1_Healthy_Leaf: 0.0000, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.0000, f1_Leaf_Variegation: 0.1269
2025-05-28 13:08:58 - __main__ - INFO - [main_execution_logic:363] - E6: Val f1_macro (0.0181) not better than 0.1396. Patience: 1/15
2025-05-28 13:08:58 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E6 End: Alloc 3170.6MB
2025-05-28 13:09:37 - phase4_finetuning.finetune.trainer - INFO - [train_one_epoch:115] - Epoch 7 training finished. Avg Loss: 2.0317, Final LR for epoch: 1.00e-04, Opt Steps: 53
2025-05-28 13:09:42 - phase4_finetuning.finetune.trainer - INFO - [validate_one_epoch:165] - Validation finished. Avg Loss: 1.9353, accuracy: 0.1192, f1_macro: 0.0323, f1_weighted: 0.0291, precision_macro: 0.1596, precision_weighted: 0.2941, recall_macro: 0.1440, recall_weighted: 0.1192, f1_Bacterial_Blight: 0.0000, f1_Curl_Virus: 0.0000, f1_Healthy_Leaf: 0.2096, f1_Herbicide_Growth_Damage: 0.0000, f1_Leaf_Hopper_Jassids: 0.0000, f1_Leaf_Redding: 0.0165, f1_Leaf_Variegation: 0.0000
2025-05-28 13:09:42 - __main__ - INFO - [main_execution_logic:363] - E7: Val f1_macro (0.0323) not better than 0.1396. Patience: 2/15
2025-05-28 13:09:42 - __main__ - DEBUG - [main_execution_logic:366] - CUDA Mem E7 End: Alloc 3170.6MB
