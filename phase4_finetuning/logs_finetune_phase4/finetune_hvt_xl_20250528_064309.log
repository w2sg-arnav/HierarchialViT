2025-05-28 06:43:09,473 - root - INFO - Logging configured. Log file: /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_phase4/finetune_hvt_xl_20250528_064309.log
2025-05-28 06:43:09,474 - __main__ - INFO - ======== Starting Phase 4: HVT Fine-tuning (Run ID: 20250528_064309) ========
2025-05-28 06:43:09,474 - __main__ - INFO - Full run configuration: {'seed': 42, 'device': 'cuda', 'log_dir': 'logs_finetune_phase4', 'log_file_finetune': 'finetune_hvt_xl.log', 'best_model_filename': 'best_finetuned_hvt_xl.pth', 'final_model_filename': 'final_finetuned_hvt_xl.pth', 'checkpoint_save_dir_name': 'checkpoints', 'data_root': '/teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection', 'original_dataset_name': 'Original Dataset', 'augmented_dataset_name': 'Augmented Dataset', 'img_size': (448, 448), 'num_classes': 7, 'train_split_ratio': 0.8, 'normalize_data': True, 'use_weighted_sampler': True, 'num_workers': 4, 'prefetch_factor': 2, 'model_architecture_name': 'DiseaseAwareHVT_SSL_Finetuned', 'pretrained_checkpoint_path': '/teamspace/studios/this_studio/cvpr25/phase3_pretraining/pretrain_checkpoints_hvt_xl/hvt_xl_simclr_t4_resumed_best_probe.pth', 'load_pretrained_backbone': True, 'freeze_backbone_epochs': 0, 'unfreeze_backbone_lr_factor': 0.1, 'hvt_params_for_model_init': {'patch_size': 14, 'embed_dim_rgb': 192, 'embed_dim_spectral': 192, 'spectral_channels': 0, 'depths': [3, 6, 24, 3], 'num_heads': [6, 12, 24, 48], 'mlp_ratio': 4.0, 'qkv_bias': True, 'model_drop_rate': 0.1, 'attn_drop_rate': 0.0, 'drop_path_rate': 0.1, 'norm_layer_name': 'LayerNorm', 'use_dfca': False, 'use_gradient_checkpointing': False, 'ssl_enable_mae': False, 'ssl_enable_contrastive': False, 'enable_consistency_loss_heads': False, 'dfca_embed_dim_match_rgb': True, 'dfca_num_heads': 32, 'dfca_drop_rate': 0.1, 'dfca_use_disease_mask': True, 'ssl_mae_mask_ratio': 0.75, 'ssl_mae_decoder_dim': 64, 'ssl_mae_norm_pix_loss': True, 'ssl_contrastive_projector_dim': 128, 'ssl_contrastive_projector_depth': 2}, 'enable_torch_compile': False, 'torch_compile_mode': 'reduce-overhead', 'matmul_precision': 'high', 'cudnn_benchmark': True, 'epochs': 30, 'batch_size': 16, 'accumulation_steps': 2, 'amp_enabled': True, 'clip_grad_norm': 1.0, 'log_interval': 10, 'optimizer': 'AdamW', 'learning_rate': 3e-05, 'head_lr_multiplier': 1.0, 'weight_decay': 0.05, 'optimizer_params': {'betas': (0.9, 0.999)}, 'scheduler': 'WarmupCosine', 'warmup_epochs': 3, 'eta_min_lr': 1e-07, 'loss_label_smoothing': 0.1, 'augmentations_enabled': True, 'evaluate_every_n_epochs': 1, 'early_stopping_patience': 10, 'metric_to_monitor_early_stopping': 'f1_macro'}
2025-05-28 06:43:09,478 - __main__ - INFO - Global random seed set to: 42
2025-05-28 06:43:09,478 - __main__ - INFO - Using device: cuda
2025-05-28 06:43:09,514 - __main__ - INFO - GPU: Tesla T4; CUDA Ver: 12.1
2025-05-28 06:43:09,514 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (448, 448)
2025-05-28 06:43:09,515 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-05-28 06:43:09,678 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Augmented Dataset
2025-05-28 06:43:09,993 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Total valid image paths collected: 9137 from ~9137 items considered.
2025-05-28 06:43:09,994 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Dataset split size: 7309 samples.
2025-05-28 06:43:09,995 - phase4_finetuning.dataset - INFO - [DATASET INIT - train] Base RGB Transforms: Compose(
      ToImage()
      ToDtype(scale=False)
      Resize(size=[448, 448], interpolation=InterpolationMode.BICUBIC, antialias=True)
      Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225], inplace=False)
)
2025-05-28 06:43:09,995 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (448, 448)
2025-05-28 06:43:09,996 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-05-28 06:43:10,080 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Augmented Dataset
2025-05-28 06:43:10,389 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Total valid image paths collected: 9137 from ~9137 items considered.
2025-05-28 06:43:10,390 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Dataset split size: 1828 samples.
2025-05-28 06:43:10,390 - phase4_finetuning.dataset - INFO - [DATASET INIT - val] Base RGB Transforms: Compose(
      ToImage()
      ToDtype(scale=False)
      Resize(size=[448, 448], interpolation=InterpolationMode.BICUBIC, antialias=True)
      Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225], inplace=False)
)
2025-05-28 06:43:10,423 - phase4_finetuning.dataset - INFO - Computed class weights for split 'train': [1.029 0.912 1.065 1.014 1.05  0.833 1.172]
2025-05-28 06:43:10,475 - __main__ - INFO - Using WeightedRandomSampler for training.
2025-05-28 06:43:10,476 - __main__ - INFO - Dataloaders created. Train batches: 456, Val batches: 115
2025-05-28 06:43:10,476 - phase2_model.models.hvt - INFO - Factory: Creating DiseaseAwareHVT for img_size: (448, 448), num_classes: 7
2025-05-28 06:43:13,151 - phase2_model.models.hvt - INFO - HVT: Running RGB stream only. No fusion.
2025-05-28 06:43:15,538 - phase2_model.models.hvt - INFO - DiseaseAwareHVT initialized for image size (448, 448) and 7 classes.
2025-05-28 06:43:15,539 - __main__.load_and_prepare_model - INFO - Instantiated DiseaseAwareHVT with arch: [3, 6, 24, 3], embed_dim: 192
2025-05-28 06:43:15,542 - __main__.load_and_prepare_model - INFO - Loading SSL pre-trained backbone weights from: /teamspace/studios/this_studio/cvpr25/phase3_pretraining/pretrain_checkpoints_hvt_xl/hvt_xl_simclr_t4_resumed_best_probe.pth
2025-05-28 06:43:19,257 - __main__ - CRITICAL - Unhandled CRITICAL exception in __main__: 'pretrain_img_size'
Traceback (most recent call last):
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/main.py", line 474, in <module>
    main()
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/main.py", line 320, in main
    model = load_and_prepare_model(cfg, device)
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/main.py", line 185, in load_and_prepare_model
    ssl_img_size_tuple = tuple(ssl_run_config_snapshot.get('pretrain_img_size', cfg['pretrain_img_size'])) # Fallback to current if not found
KeyError: 'pretrain_img_size'
