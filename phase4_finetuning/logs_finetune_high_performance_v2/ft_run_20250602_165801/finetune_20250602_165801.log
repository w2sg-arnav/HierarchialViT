2025-06-02 16:58:01 - root - INFO - [setup_logging:75] - Logging configured. Log file: /teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_high_performance_v2/ft_run_20250602_165801/finetune_20250602_165801.log. Logger 'root' Effective Level: DEBUG
2025-06-02 16:58:01 - __main__ - INFO - [main_execution_logic:296] - ======== Starting Phase 4 Fine-tuning (Run: ft_run_20250602_165801) ========
2025-06-02 16:58:01 - __main__ - INFO - [main_execution_logic:297] - Full effective configuration for this run: {'seed': 42, 'device': 'cuda', 'PACKAGE_ROOT_PATH': '/teamspace/studios/this_studio/cvpr25/phase4_finetuning', 'PROJECT_ROOT_PATH': '/teamspace/studios/this_studio/cvpr25', 'log_dir': 'logs_finetune_high_performance_v2', 'log_file_finetune': 'finetune_hvt_high_performance_v2.log', 'best_model_filename': 'best_finetuned_hvt_high_performance_v2.pth', 'final_model_filename': 'final_finetuned_hvt_high_performance_v2.pth', 'checkpoint_save_dir_name': 'checkpoints_high_performance_v2', 'resume_from_checkpoint': '/teamspace/studios/this_studio/cvpr25/phase4_finetuning/logs_finetune_optimized_strategy_v1_stable/checkpoints_optimized_strategy_v1_stable/best_finetuned_hvt_optimized_strategy_v1_stable.pth', 'data_root': '/teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection', 'original_dataset_name': 'Original Dataset', 'augmented_dataset_name': 'Augmented Dataset', 'img_size': (512, 512), 'num_classes': 7, 'train_split_ratio': 0.9, 'normalize_data': True, 'use_weighted_sampler': True, 'weighted_sampler_mode': 'inv_count', 'use_weighted_loss': True, 'focal_loss_alpha': 0.25, 'focal_loss_gamma': 2.0, 'num_workers': 6, 'prefetch_factor': 3, 'model_architecture_name': 'DiseaseAwareHVT_HighPerformance_v2', 'pretrained_checkpoint_path': '/teamspace/studios/this_studio/cvpr25/phase3_pretraining/pretrain_checkpoints_hvt_xl/hvt_xl_simclr_t4_resumed_best_probe.pth', 'load_pretrained_backbone': True, 'hvt_params_for_model_init': {'patch_size': 14, 'embed_dim_rgb': 192, 'embed_dim_spectral': 192, 'spectral_channels': 0, 'depths': [3, 6, 24, 3], 'num_heads': [6, 12, 24, 48], 'mlp_ratio': 4.0, 'qkv_bias': True, 'model_drop_rate': 0.15, 'attn_drop_rate': 0.1, 'drop_path_rate': 0.2, 'norm_layer_name': 'LayerNorm', 'use_dfca': False, 'use_gradient_checkpointing': True, 'ssl_enable_mae': False, 'ssl_enable_contrastive': False, 'enable_consistency_loss_heads': False, 'dfca_embed_dim_match_rgb': True, 'dfca_num_heads': 32, 'dfca_drop_rate': 0.1, 'dfca_use_disease_mask': True, 'ssl_mae_mask_ratio': 0.75, 'ssl_mae_decoder_dim': 64, 'ssl_mae_norm_pix_loss': True, 'ssl_contrastive_projector_dim': 128, 'ssl_contrastive_projector_depth': 2, 'layer_wise_lr_decay': 0.8}, 'enable_torch_compile': True, 'torch_compile_mode': 'max-autotune', 'matmul_precision': 'high', 'cudnn_benchmark': True, 'freeze_backbone_epochs': 3, 'progressive_unfreezing': True, 'unfreezing_schedule': [3, 8, 15, 20], 'epochs': 250, 'batch_size': 6, 'accumulation_steps': 8, 'amp_enabled': True, 'amp_opt_level': 'O1', 'clip_grad_norm': 1.0, 'optimizer': 'AdamW', 'optimizer_params': {'betas': (0.9, 0.999), 'eps': 1e-08, 'amsgrad': True}, 'weight_decay': 0.01, 'lr_head_frozen_phase': 0.0003, 'lr_backbone_unfrozen_phase': 5e-05, 'lr_head_unfrozen_phase': 0.0002, 'use_layer_wise_lr': True, 'layer_wise_lr_multipliers': {'head': 1.0, 'layer_4': 0.9, 'layer_3': 0.8, 'layer_2': 0.7, 'layer_1': 0.6}, 'scheduler': 'OneCycleLR', 'onecycle_max_lr': 0.001, 'onecycle_pct_start': 0.1, 'onecycle_div_factor': 25, 'onecycle_final_div_factor': 10000.0, 'warmup_epochs': 10, 'eta_min_lr': 1e-08, 'loss_function': 'combined', 'loss_label_smoothing': 0.15, 'loss_weights': {'ce_weight': 0.7, 'focal_weight': 0.3}, 'augmentations_enabled': True, 'augmentation_strategy': 'aggressive_medical', 'augmentation_severity': 'high', 'mixup_alpha': 0.4, 'cutmix_alpha': 1.0, 'cutmix_prob': 0.5, 'rand_augment_n': 3, 'rand_augment_m': 12, 'tta_enabled_val': True, 'tta_transforms': 8, 'use_ema': True, 'ema_decay': 0.9999, 'use_swa': True, 'swa_start_epoch': 200, 'swa_lr': 1e-05, 'use_knowledge_distillation': False, 'teacher_model_path': None, 'distillation_alpha': 0.7, 'distillation_temperature': 4.0, 'evaluate_every_n_epochs': 1, 'early_stopping_patience': 40, 'metric_to_monitor_early_stopping': 'f1_macro', 'min_delta_early_stopping': 0.0001, 'ssl_pretrain_img_size_fallback': (448, 448), 'debug_nan_detection': True, 'stop_on_nan_threshold': 3, 'monitor_gradients': True, 'gradient_log_interval': 25, 'save_checkpoint_every_n_epochs': 5, 'use_lr_finder': False, 'lr_finder_start_lr': 1e-07, 'lr_finder_end_lr': 0.1, 'lr_finder_num_iter': 100, 'cross_validation_folds': 0, 'stratified_sampling': True, 'save_top_k_models': 5, 'ensemble_inference': False, 'dropout_schedule': {0: 0.1, 50: 0.15, 100: 0.2, 150: 0.15, 200: 0.1}, 'max_memory_usage': 0.9, 'empty_cache_frequency': 10}
2025-06-02 16:58:01 - __main__ - INFO - [set_global_seed:125] - Global random seed set to: 42
2025-06-02 16:58:01 - __main__ - INFO - [main_execution_logic:300] - Device: cuda. GPU: Tesla T4
2025-06-02 16:58:01 - __main__ - INFO - [main_execution_logic:301] - cudnn.benchmark = True
2025-06-02 16:58:01 - __main__ - INFO - [main_execution_logic:303] - matmul_precision = 'high'
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:56] - [DATASET INIT - train] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (512, 512)
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:76] - [DATASET INIT - train] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:76] - [DATASET INIT - train] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Augmented Dataset
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:107] - [DATASET INIT - train] Total valid image paths collected: 9137 from ~9137 items considered.
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:119] - [DATASET INIT - train] Dataset split size: 8223 samples.
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:56] - [DATASET INIT - val] Root: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection, ImgSize: (512, 512)
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:76] - [DATASET INIT - val] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Original Dataset
2025-06-02 16:58:01 - phase4_finetuning.dataset - INFO - [__init__:76] - [DATASET INIT - val] Scanning: /teamspace/studios/this_studio/cvpr25/SAR-CLD-2024 A Comprehensive Dataset for Cotton Leaf Disease Detection/Augmented Dataset
2025-06-02 16:58:02 - phase4_finetuning.dataset - INFO - [__init__:107] - [DATASET INIT - val] Total valid image paths collected: 9137 from ~9137 items considered.
2025-06-02 16:58:02 - phase4_finetuning.dataset - INFO - [__init__:119] - [DATASET INIT - val] Dataset split size: 914 samples.
2025-06-02 16:58:02 - __main__ - INFO - [create_weighted_sampler:224] - WeightedRandomSampler created with mode: inv_count.
2025-06-02 16:58:02 - __main__ - INFO - [main_execution_logic:322] - Dataloaders: Train batches=1370, Val batches=77
2025-06-02 16:58:02 - phase2_model.models.hvt - INFO - [create_disease_aware_hvt:602] - Factory: Creating DiseaseAwareHVT for img_size: (512, 512), num_classes: 7
2025-06-02 16:58:02 - phase2_model.models.hvt - WARNING - [__init__:34] - PatchEmbed: Img dims (512, 512) not perfectly divisible by patch_size 14.
2025-06-02 16:58:04 - phase2_model.models.hvt - INFO - [__init__:325] - HVT: Running RGB stream only. No fusion.
2025-06-02 16:58:07 - phase2_model.models.hvt - INFO - [__init__:359] - DiseaseAwareHVT initialized for image size (512, 512) and 7 classes.
2025-06-02 16:58:07 - __main__ - INFO - [main_execution_logic:327] - Base HVT model created (num_classes=7).
2025-06-02 16:58:07 - __main__ - CRITICAL - [<module>:476] - Unhandled CRITICAL exception in __main__ execution: name 'AdamW' is not defined
Traceback (most recent call last):
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/main.py", line 467, in <module>
    main_execution_logic()
  File "/teamspace/studios/this_studio/cvpr25/phase4_finetuning/main.py", line 337, in main_execution_logic
    if optim_name == "adamw": optimizer = AdamW(param_groups_for_optimizer, lr=cfg['lr_head_unfrozen_phase'], weight_decay=wd_cfg, **opt_kwargs_cfg) # Default LR, will be set per epoch
NameError: name 'AdamW' is not defined
